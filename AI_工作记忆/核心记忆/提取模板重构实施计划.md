# 提取模板功能重构实施计划

## 🎯 **总体目标**
按照用户建议的四步流程，重构"提取模板"功能，实现智能化、条件化的用户交互体验。

## 📋 **实施步骤**

### **Step 1: 创建环境检测模块**
**目标**: 实现全面的状态检测功能
**文件**: `day_translation/utils/environment_detector.py`

#### 1.1 创建检测器类
```python
class ExtractionEnvironmentDetector:
    def detect_mod_resources(self, mod_dir: str) -> dict
    def detect_output_status(self, output_dir: str) -> dict
    def generate_status_summary(self, mod_status: dict, output_status: dict) -> str
```

#### 1.2 实现检测逻辑
- [x] 检测英文 DefInjected 目录
- [x] 检测英文 Keyed 目录 
- [x] 统计文件数量和大小
- [x] 检测输出目录状态
- [x] 检测现有翻译文件

#### 1.3 美化状态显示
- [x] 使用表格和图标显示状态
- [x] 添加路径和统计信息
- [x] 使用颜色增强可读性

---

### **Step 2: 重构用户交互界面**
**目标**: 实现条件化、智能化的用户选择流程
**文件**: `day_translation/interaction/extraction_wizard.py`

#### 2.1 创建交互向导类
```python
class ExtractionWizard:
    def run_smart_workflow(self, mod_dir: str, output_dir: str) -> ExtractionConfig
    def prompt_data_source_choice(self, env_status: dict) -> str
    def prompt_conflict_resolution(self, env_status: dict) -> str
    def prompt_organization_choice(self) -> str
```

#### 2.2 实现条件化界面
- [x] 数据来源选择（基于检测结果）
- [x] 冲突处理选择（仅在有冲突时显示）
- [x] 文件组织选择（基于数据来源智能确定）
- [x] 添加返回主菜单选项

#### 2.3 优化用户体验
- [x] 提供选择建议和说明
- [x] 显示预估工作量
- [x] 添加确认和取消机制

---

### **Step 3: 重构核心提取逻辑**
**目标**: 修复"以英文 DefInjected 为基础"功能，实现智能提取
**文件**: `day_translation/core/smart_extractor.py`

#### 3.1 创建智能提取器
```python
class SmartExtractor:
    def extract_with_config(self, config: ExtractionConfig) -> ExtractionResults
    def extract_from_definjected(self, mod_dir: str) -> List[TranslationItem]
    def extract_from_defs(self, mod_dir: str) -> List[TranslationItem]
```

#### 3.2 修复 DefInjected 提取
- [ ] **关键问题**: 修复"以英文 DefInjected 为基础"的逻辑错误
- [ ] 确保提取结构而非内容
- [ ] 生成正确的模板格式
- [ ] 保留英文注释作为参考

#### 3.3 优化 Defs 扫描
- [ ] 改进递归字段提取逻辑
- [ ] 优化性能和内存使用
- [ ] 增强错误处理

---

### **Step 4: 实现冲突处理机制**
**目标**: 提供智能的文件冲突处理
**文件**: `day_translation/utils/conflict_resolver.py`

#### 4.1 创建冲突解决器
```python
class ConflictResolver:
    def smart_merge(self, existing_files: list, new_content: list) -> MergeResults
    def create_backup(self, target_dir: str) -> str
    def generate_merge_report(self, results: MergeResults) -> str
```

#### 4.2 实现处理策略
- [ ] 智能合并算法
- [ ] 自动备份机制
- [ ] 覆盖确认流程
- [ ] 详情查看功能

---

### **Step 5: 重构主程序集成**
**目标**: 将新模块集成到主程序中
**文件**: `day_translation/main.py`, `day_translation/core/template_manager.py`

#### 5.1 修改主程序调用
- [ ] 替换现有的提取模板逻辑
- [ ] 集成新的交互向导
- [ ] 更新错误处理

#### 5.2 更新模板管理器
- [ ] 重构 `extract_and_generate_templates` 方法
- [ ] 使用新的智能提取器
- [ ] 集成冲突解决机制

---

### **Step 6: 完善进度反馈系统**
**目标**: 提供完整的进度和状态反馈
**文件**: `day_translation/utils/progress_manager.py`

#### 6.1 创建进度管理器
```python
class ProgressManager:
    def show_detection_progress(self)
    def show_extraction_progress(self, current: int, total: int, current_file: str)
    def show_completion_summary(self, results: ExtractionResults)
```

#### 6.2 实现反馈界面
- [ ] 检测阶段进度条
- [ ] 提取阶段实时进度
- [ ] 完成后统计摘要
- [ ] 错误和警告反馈

---

## 🔧 **具体实施顺序**

### Phase 1: 基础模块（1-2天）
1. ✅ 创建环境检测器 (`environment_detector.py`)
2. ✅ 实现状态检测逻辑
3. ✅ 美化状态显示界面

### Phase 2: 交互界面（1-2天）
4. ✅ 创建交互向导 (`extraction_wizard.py`)
5. ✅ 实现条件化用户选择
6. ✅ 优化用户体验

### Phase 3: 核心修复（2-3天）⭐**当前重点**
7. 🔄 **进行中**: 修复"以英文 DefInjected 为基础"功能
8. ⏳ 创建智能提取器
9. ⏳ 优化提取算法

### Phase 4: 冲突处理（1天）
10. ⏳ 实现冲突解决器
11. ⏳ 添加备份和合并功能

### Phase 5: 集成测试（1天）
12. ⏳ 集成所有新模块
13. ⏳ 全面测试各种场景
14. ⏳ 用户体验最终优化

---

## ✅ **验收标准**

### 功能验收
- [ ] 状态检测准确完整
- [ ] 用户界面清晰易用
- [ ] "以英文 DefInjected 为基础"功能正确
- [ ] 冲突处理稳定可靠
- [ ] 所有选择组合都正常工作

### 用户体验验收
- [ ] 减少了至少50%的用户选择步骤
- [ ] 提供清晰的状态反馈
- [ ] 智能默认选项合理
- [ ] 错误提示友好明确

### 技术验收  
- [ ] 代码结构清晰模块化
- [ ] 错误处理完善
- [ ] 性能满足要求
- [ ] 测试覆盖充分

---

## 🚨 **风险控制**

### 技术风险
- **风险**: DefInjected 提取逻辑复杂，容易出错
- **缓解**: 分步测试，保留原有逻辑作为回退方案

### 用户体验风险
- **风险**: 新界面可能让用户不适应
- **缓解**: 保持核心操作简单，提供帮助说明

### 兼容性风险
- **风险**: 不同模组结构差异导致异常
- **缓解**: 广泛测试各种模组，完善异常处理

---

**创建时间**: 2025-06-27  
**当前状态**: Phase 3 进行中  
**下一个里程碑**: 修复 DefInjected 提取功能
