# æ™ºèƒ½åˆå¹¶æµç¨‹è®¾è®¡æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº† Day Translation å·¥å…·ä¸­æ™ºèƒ½åˆå¹¶åŠŸèƒ½çš„å®Œæ•´æµç¨‹è®¾è®¡ï¼ŒåŒ…æ‹¬å†³ç­–æ ‘ã€æ•°æ®ç»“æ„ã€å®ç°æ–¹æ¡ˆå’Œå¾…åŠäº‹é¡¹ã€‚æ™ºèƒ½åˆå¹¶åŠŸèƒ½è´Ÿè´£å°†æ–°æå–çš„ç¿»è¯‘æ•°æ®ä¸ç°æœ‰ç¿»è¯‘æ–‡ä»¶è¿›è¡Œæ™ºèƒ½åˆå¹¶ï¼Œä¿ç•™å†å²è®°å½•å’Œè‹±æ–‡æ³¨é‡Šã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### ç›®å½•çŠ¶æ€åˆ¤å®šæ ‡å‡†
- **æœ‰æ•ˆç›®å½•**: ç›®å½•å­˜åœ¨ä¸”åŒ…å«è‡³å°‘ä¸€ä¸ª `.xml` æ–‡ä»¶
- **åˆ¤å®šæ–¹æ³•**: `os.path.isdir(path) && len(list(Path(path).rglob('*.xml'))) > 0`

### æ•°æ®æ ¼å¼è§„èŒƒ
- **è¾“å…¥æ•°æ®**: `(key, text, tag, rel_path)` - å››å…ƒç»„æ ¼å¼
- **è¾“å‡ºæ•°æ®**: `(key, text, tag, rel_path, en_text)` - äº”å…ƒç»„æ ¼å¼ï¼ŒåŒ…å«è‹±æ–‡æ³¨é‡Š
- **åˆå¹¶ç»“æœ**: ç»Ÿä¸€ä½¿ç”¨äº”å…ƒç»„æ ¼å¼ï¼Œæ”¯æŒå†å²è®°å½•

## ğŸ”§ å†³ç­–å‚æ•°å®šä¹‰

### 1. ç›®å½•çŠ¶æ€æ£€æµ‹
- **1.1 è¾“å…¥ç›®å½•çŠ¶æ€**: æ£€æµ‹è¾“å…¥æ¨¡ç»„æ˜¯å¦åŒ…å« DefInjected/Keyed ç›®å½•
- **1.2 è¾“å‡ºç›®å½•çŠ¶æ€**: æ£€æµ‹è¾“å‡ºç›®å½•æ˜¯å¦å·²å­˜åœ¨ç¿»è¯‘æ–‡ä»¶

### 2. æ•°æ®æ¥æºé€‰æ‹© (data_source_choice)
- **2.1 definjected_only**: ä»…ä½¿ç”¨è‹±æ–‡ DefInjected ç›®å½•ä½œä¸ºæ•°æ®æº
- **2.2 defs_only**: æ‰«æ Defs æ–‡ä»¶å¤¹æå–å¯ç¿»è¯‘å†…å®¹

### 3. å†²çªå¤„ç†ç­–ç•¥ (conflict_resolution)
- **3.1 new**: æ–°å»º - åˆ›å»ºå…¨æ–°çš„ç¿»è¯‘ç›®å½•ç»“æ„
- **3.2 merge**: åˆå¹¶ - æ™ºèƒ½åˆå¹¶ç°æœ‰ç¿»è¯‘æ–‡ä»¶
- **3.3 overwrite**: è¦†ç›– - è¦†ç›–ç°æœ‰ç¿»è¯‘æ–‡ä»¶
- **3.4 rebuild**: é‡å»º - æ¸…ç©ºè¾“å‡ºç›®å½•åé‡æ–°ç”Ÿæˆ

### 4. æ¨¡æ¿ç»“æ„é€‰æ‹© (template_structure)
- **4.1 original_structure**: ä¿æŒåŸè‹±æ–‡ DefInjected ç»“æ„
- **4.2 defs_by_type**: æŒ‰å®šä¹‰ç±»å‹åˆ†ç»„ (å¦‚ ThingDefs.xmlã€PawnKindDefs.xml)
- **4.3 defs_by_file_structure**: æŒ‰åŸå§‹ Defs æ–‡ä»¶ç»“æ„ç»„ç»‡

## ğŸ”„ æ™ºèƒ½åˆå¹¶æ ¸å¿ƒé€»è¾‘

### 5.1 åˆå¹¶ç®—æ³•è§„åˆ™
æ™ºèƒ½åˆå¹¶åŸºäº key åŒ¹é…å’Œå†…å®¹æ¯”å¯¹ï¼Œéµå¾ªä»¥ä¸‹ä¼˜å…ˆçº§è§„åˆ™ï¼š

1. **å†…å®¹æ— å˜åŒ–**: `input_key == output_key && input_text == output_en_text`
   - **å¤„ç†**: ä¿æŒåŸçŠ¶ï¼Œä¸åšä¿®æ”¹
   
2. **å†…å®¹æœ‰æ›´æ–°**: `input_key == output_key && input_text != output_en_text`
   - **å¤„ç†**: ä½¿ç”¨æ–°å†…å®¹æ›¿æ¢åŸç¿»è¯‘ï¼Œä¿ç•™å†å²æ³¨é‡Šï¼Œæ›´æ–° EN æ³¨é‡Š
   
3. **æ–°å¢å†…å®¹**: `input_key` åœ¨è¾“å‡ºä¸­ä¸å­˜åœ¨
   - **å¤„ç†**: æ–°å¢ç¿»è¯‘æ¡ç›®ï¼Œæ·»åŠ  EN æ³¨é‡Š

### 5.2 æ³¨é‡Šæ ¼å¼è§„èŒƒ

```xml
<!-- å®Œæ•´ç¤ºä¾‹ -->
<!--HISTORY: åŸç¿»è¯‘å†…å®¹ï¼šæ—§çš„ä¸­æ–‡ç¿»è¯‘ï¼Œæ›¿æ¢äº2024-06-07-->
<!--EN: Updated English Text-->
<key>æ›´æ–°åçš„ä¸­æ–‡ç¿»è¯‘</key>
```

**æ³¨é‡Šè§„åˆ™**:
- **EN æ³¨é‡Š**: å¿…é¡»å­˜åœ¨ï¼Œå†…å®¹ä¸æœ€æ–°è‹±æ–‡åŸæ–‡åŒæ­¥
- **å†å²æ³¨é‡Š**: æ›¿æ¢æ—¶æ·»åŠ ï¼Œè®°å½•åŸç¿»è¯‘å†…å®¹å’Œæ›¿æ¢æ—¶é—´
- **æ³¨é‡Šé¡ºåº**: å†å²æ³¨é‡Šåœ¨å‰ï¼ŒEN æ³¨é‡Šåœ¨å

## ğŸ“Š æ™ºèƒ½åˆå¹¶æ•°æ®ç»“æ„ä¸å®ç°

### 1. æ•°æ®æå–ä¸ç»“æ„

#### è¾“å…¥ç›®å½•æ•°æ®æå–
- **æ–¹æ³•**: é€šè¿‡ `_extract_all_translations` è·å–
- **è¿”å›æ ¼å¼**: `(key, text, tag, file)`
- **è¯´æ˜**: ä»è¾“å…¥æ¨¡ç»„ç›®å½•æå–çš„åŸæ–‡ç¿»è¯‘æ•°æ®

#### è¾“å‡ºç›®å½•æ•°æ®æå–
- **æ–¹æ³•**: é€šè¿‡ `_extract_all_translations` è·å–
- **è¿”å›æ ¼å¼**: `(key, text, tag, file, en_text)`
- **è¯´æ˜**: ä»ç°æœ‰ç¿»è¯‘ç›®å½•æå–ï¼ŒåŒ…å« EN æ³¨é‡Šå†…å®¹

### 2. åˆå¹¶é€»è¾‘å®ç°

åŸºäº 5.1 è§„åˆ™ï¼Œç»“åˆå®é™…éœ€æ±‚çš„åˆå¹¶é€»è¾‘ï¼š

- **éå†è¾“å…¥ç›®å½•çš„æ‰€æœ‰ key**ï¼š
  - **å¦‚æœ key åœ¨è¾“å‡ºç›®å½•ä¹Ÿå­˜åœ¨**ï¼š
    - å¦‚æœ `text`ï¼ˆè¾“å…¥ï¼‰å’Œ `en_text`ï¼ˆè¾“å‡ºçš„ENæ³¨é‡Šï¼‰ç›¸åŒï¼š
      â†’ åˆ é™¤è¿™æ¡æ•°æ®ï¼ˆæ— éœ€å˜æ›´ï¼Œä¿æŒåŸçŠ¶ï¼‰
    - å¦‚æœ `text`ï¼ˆè¾“å…¥ï¼‰å’Œ `en_text` ä¸åŒï¼š
      â†’ ç”¨è¾“å…¥çš„ `text` æ›¿æ¢è¾“å‡ºçš„ `text`ï¼Œå¹¶å°†åŸæœ¬çš„ `text` ä½œä¸ºå†å²æ³¨é‡Šæ’å…¥
  - **å¦‚æœ key åœ¨è¾“å‡ºç›®å½•ä¸å­˜åœ¨**ï¼š
    â†’ æ–°å¢ï¼Œå¸¦ EN æ³¨é‡Š

### 3. åˆå¹¶åæ•°æ®ç»“æ„

- **æ–°å¢**: `{"key": ..., "text": ..., "tag": ..., "file": ..., "en_text": ...}`
- **æ›¿æ¢**: `{"key": ..., "text": ..., "tag": ..., "file": ..., "en_text": ..., "history": ...}`

### 4. å®ç°å»ºè®®

#### æ‰©å±• extract_definjected_translations
- æ”¯æŒæå– EN æ³¨é‡Šï¼ˆå¦‚ `<!--EN: ...-->`ï¼‰ï¼Œå¹¶ä½œä¸º `en_text` å­—æ®µè¿”å›
- å»ºè®®ç”¨ lxml è§£ææ³¨é‡ŠèŠ‚ç‚¹ï¼Œå…³è”åˆ°ä¸‹ä¸€ä¸ª key

#### åˆå¹¶ç®—æ³•ä¼˜åŒ–
- ç”¨ dict ç»“æ„åŠ é€Ÿ key åŒ¹é…
- åˆå¹¶æ—¶æŒ‰ä¸Šè¿°è§„åˆ™å¤„ç†ï¼Œç”Ÿæˆæœ€ç»ˆ list

#### XML å†™å›å¤„ç†
- æŒ‰ file åˆ†ç»„ï¼Œæ‰¹é‡å†™å›
- æ›¿æ¢æ—¶æ’å…¥å†å²æ³¨é‡Šï¼Œæ–°å¢æ—¶æ’å…¥ EN æ³¨é‡Š

### 5. æ³¨æ„äº‹é¡¹

- **ENæ³¨é‡Šçš„æå–ä¸å…³è”**: éœ€å¢å¼º XML è§£æé€»è¾‘ï¼Œç¡®ä¿èƒ½æŠŠæ³¨é‡Šå’Œ key å…³è”èµ·æ¥
- **å†å²æ³¨é‡Šæ ¼å¼**: ç»Ÿä¸€ç”¨ `<!--HISTORY: åŸç¿»è¯‘å†…å®¹ï¼šxxxï¼Œæ›¿æ¢äºYYYY-MM-DD-->`
- **æ€§èƒ½ä¼˜åŒ–**: å¤§æ–‡ä»¶å»ºè®®ç”¨ lxmlï¼Œä¸”ç”¨ dict åŠ é€Ÿ key åŒ¹é…
- **Keyed ç›®å½•æ‰©å±•**: å¦‚éœ€åŒæ ·å¤„ç†ï¼Œå»ºè®®åŒæ­¥æ‰©å±•

## ğŸš€ æ™ºèƒ½åˆå¹¶ä¸»æµç¨‹

### æµç¨‹æ­¥éª¤

1. **å‚æ•°è·å–**
   - è¾“å…¥æ¨¡ç»„ç›®å½•ï¼ˆinput_mod_dirï¼‰
   - è¾“å‡ºç›®å½•ï¼ˆoutput_dirï¼‰
   - æ•°æ®æºé€‰æ‹©ï¼ˆdata_source_choiceï¼‰
   - æ¨¡æ¿ç»“æ„ï¼ˆtemplate_structureï¼‰

2. **æå–è¾“å…¥ç›®å½•ç¿»è¯‘**
   - é€šè¿‡ `_extract_all_translations` æ–¹æ³•
   - ä¼ å…¥è¾“å…¥ç›®å½•è·¯å¾„å’Œç›¸å…³å‚æ•°
   - è·å–è¾“å…¥ç›®å½•ä¸‹æ‰€æœ‰å¯ç”¨çš„ç¿»è¯‘æ•°æ®

3. **æå–è¾“å‡ºç›®å½•ç¿»è¯‘**
   - é€šè¿‡ `_extract_all_translations` æ–¹æ³•
   - ä¼ å…¥è¾“å‡ºç›®å½•è·¯å¾„å’Œç›¸å…³å‚æ•°
   - è·å–è¾“å‡ºç›®å½•ä¸‹æ‰€æœ‰ç°æœ‰çš„ç¿»è¯‘æ•°æ®

4. **ç¿»è¯‘å¯¹æ¯”ä¸åˆå¹¶**
   - å¯¹æ¯”è¾“å…¥ç›®å½•ï¼ˆæºè¯­è¨€ï¼‰å’Œè¾“å‡ºç›®å½•ï¼ˆç›®æ ‡è¯­è¨€ï¼‰çš„ç¿»è¯‘å†…å®¹
   - æŒ‰ç…§ 5.1 åˆå¹¶é€»è¾‘ï¼ˆkeyã€ENæ³¨é‡Šã€å†å²æ³¨é‡Šç­‰ï¼‰è¿›è¡Œåˆå¹¶å¤„ç†
   - ç”Ÿæˆæœ€ç»ˆçš„åˆå¹¶ç»“æœ

5. **åç»­å¤„ç†**
   - ç”Ÿæˆåˆå¹¶åçš„æ¨¡æ¿æ–‡ä»¶
   - è¾“å‡ºåˆå¹¶ç»Ÿè®¡ä¿¡æ¯

### 6.1 åˆå¹¶æå–é€»è¾‘è¯¦è§£

- **åˆå¹¶åŸåˆ™**: ä»¥è¾“å‡ºç›®å½•ä¸ºä¸»ï¼Œè¾“å…¥ç›®å½•ï¼ˆæ–°æå–çš„æ•°æ®ï¼‰ä¸ºå¢é‡/æ›´æ–°
- **å¤„ç†æµç¨‹**: éå†è¾“å‡ºç›®å½• DefInjected çš„ keyï¼Œå’Œè¾“å…¥ç›®å½•æ–°æå–çš„ key è¿›è¡Œæ¯”å¯¹ï¼ŒæŒ‰ 5.1 é€»è¾‘å¤„ç†
- **æ–°å¢å¤„ç†**: æ–°å¢çš„ key ä¹Ÿè¦æ’å…¥åˆ°è¾“å‡ºç›®å½•çš„ XML æ–‡ä»¶ä¸­ï¼Œå¹¶å¸¦ä¸Š EN æ³¨é‡Š

#### æ•°æ®æ¥æºå¤„ç†ç­–ç•¥

- **é€‰æ‹© 2.1 (definjected_only)**ï¼š
  - ä½¿ç”¨ 2.1 ä½œä¸ºæ•°æ®æ¥æº
  - æå–è¾“å‡ºç›®å½• DefInjected çš„ key å’Œ text
  - ä½¿ç”¨ 5.1 åˆå¹¶é€»è¾‘

- **é€‰æ‹© 2.2 (defs_only)**ï¼š
  - ä½¿ç”¨ 2.2 ä½œä¸ºæ•°æ®æ¥æº
  - æå–è¾“å‡ºç›®å½• DefInjected çš„ key å’Œ text
  - ä½¿ç”¨ 5.1 åˆå¹¶é€»è¾‘

## ğŸ”€ å†³ç­–æµç¨‹ä¸æƒ…å†µåˆ†æ

### å†³ç­–æµç¨‹æ ‘

#### æƒ…å†µä¸€ï¼šè¾“å…¥æœ‰ DefInjectedï¼Œè¾“å‡ºæœ‰ DefInjected
- **è¯¢é—®**: æ•°æ®æ¥æºé€‰æ‹© 2.1/2.2
  - **é€‰æ‹© 2.1 (definjected_only)**:
    - **è¯¢é—®**: å†²çªå¤„ç†ç­–ç•¥ 3.2/3.3/3.4
      - **é€‰æ‹© 3.2 (merge)**: ä½¿ç”¨æ™ºèƒ½åˆå¹¶é€»è¾‘ 5.1
      - **é€‰æ‹© 3.3/3.4 (overwrite/rebuild)**: ä½¿ç”¨æ¨¡æ¿ç»“æ„ 4.1
  - **é€‰æ‹© 2.2 (defs_only)**:
    - **è¯¢é—®**: å†²çªå¤„ç†ç­–ç•¥ 3.2/3.3/3.4
      - **é€‰æ‹© 3.2 (merge)**: ä½¿ç”¨æ™ºèƒ½åˆå¹¶é€»è¾‘ 5.1
      - **é€‰æ‹© 3.3/3.4 (overwrite/rebuild)**: è¯¢é—®æ¨¡æ¿ç»“æ„ 4.2/4.3

#### æƒ…å†µäºŒï¼šè¾“å…¥æœ‰ DefInjectedï¼Œè¾“å‡ºæ—  DefInjected
- **è¯¢é—®**: æ•°æ®æ¥æºé€‰æ‹© 2.1/2.2ï¼Œé»˜è®¤å†²çªå¤„ç†ç­–ç•¥ 3.1 (new)
  - **é€‰æ‹© 2.1 (definjected_only)**: ä½¿ç”¨æ¨¡æ¿ç»“æ„ 4.1
  - **é€‰æ‹© 2.2 (defs_only)**: è¯¢é—®æ¨¡æ¿ç»“æ„ 4.2/4.3

#### æƒ…å†µä¸‰ï¼šè¾“å…¥æ—  DefInjectedï¼Œè¾“å‡ºæœ‰ DefInjected
- **é»˜è®¤**: æ•°æ®æ¥æºé€‰æ‹© 2.2 (defs_only)
- **è¯¢é—®**: å†²çªå¤„ç†ç­–ç•¥ 3.2/3.3/3.4
  - **é€‰æ‹© 3.2 (merge)**: ä½¿ç”¨æ™ºèƒ½åˆå¹¶é€»è¾‘ 5.1ï¼ˆä» 2.2 æå–æ•°æ®ï¼Œæ£€æŸ¥è¾“å‡ºç›®å½• DefInjected çš„ key å’Œ textï¼‰
  - **é€‰æ‹© 3.3/3.4 (overwrite/rebuild)**: è¯¢é—®æ¨¡æ¿ç»“æ„ 4.2/4.3

#### æƒ…å†µå››ï¼šè¾“å…¥æ—  DefInjectedï¼Œè¾“å‡ºæ—  DefInjected
- **é»˜è®¤**: æ•°æ®æ¥æºé€‰æ‹© 2.2 (defs_only)ï¼Œå†²çªå¤„ç†ç­–ç•¥ 3.1 (new)
- **è¯¢é—®**: æ¨¡æ¿ç»“æ„ 4.2/4.3
è¾“å…¥ç›®å½•æœ‰keyedç›®å½•
é»˜è®¤æå–keyed,é»˜è®¤è¿›è¡Œæå–ã€‚
å¦‚æœæ²¡æœ‰keyedï¼Œä¸è¿›è¡Œkeyedçš„æå–ã€‚
è¾“å‡ºç›®å½•æ— keyedï¼Œçœ‹å†²çªå¤„ç†ç­–ç•¥ï¼Œæ˜¯åˆå¹¶è¿˜æ˜¯æ–°å»ºè¿˜æ˜¯æ–°å»ºå’Œè¦†ç›–ã€‚
### æµç¨‹å›¾

```mermaid
graph TD
    A[è¾“å…¥ç›®å½•æœ‰DefInjected?] -->|æ˜¯| B[è¾“å‡ºç›®å½•æœ‰DefInjected?]
    A -->|å¦| C[é»˜è®¤æ•°æ®æ¥æº2.2]
    B -->|æ˜¯| D[é€‰æ‹©æ•°æ®æ¥æº2.1/2.2]
    B -->|å¦| E[è¯¢é—®2.1/2.2, é»˜è®¤3.1]
    D -->|2.1| F[é€‰æ‹©å†²çªå¤„ç†3.2/3.3/3.4]
    D -->|2.2| G[é€‰æ‹©å†²çªå¤„ç†3.2/3.3/3.4]
    F -->|3.2| H[åˆå¹¶5.1]
    F -->|3.3/3.4| I[ä½¿ç”¨4.1]
    G -->|3.2| H
    G -->|3.3/3.4| J[è¯¢é—®4.2/4.3]
    C --> K[è¾“å‡ºç›®å½•æœ‰DefInjected?]
    K -->|æ˜¯| L[é€‰æ‹©å†²çªå¤„ç†3.2/3.3/3.4]
    K -->|å¦| M[é»˜è®¤3.1, è¯¢é—®4.2/4.3]
    L -->|3.2| H
    L -->|3.3/3.4| J
    E -->|2.1| I
    E -->|2.2| J
```

## ğŸ“ æ™ºèƒ½åˆå¹¶ç¤ºä¾‹

### åœºæ™¯ç¤ºä¾‹

#### è¾“å‡ºç›®å½•ç°æœ‰ç¿»è¯‘ï¼ˆDefInjectedï¼‰
```xml
<!--EN: Chatty Nymph-->
<rjw_chatty.title>å¥è°ˆçš„ä»™å¥³</rjw_chatty.title>
```
- **key**: `rjw_chatty.title`
- **text**: `å¥è°ˆçš„ä»™å¥³`
- **EN**: `Chatty Nymph`

#### è¾“å…¥ç›®å½•æ–°æå–æ•°æ®ï¼ˆDefInjected æˆ– Defsï¼‰
- **key**: `rjw_chatty.title`
- **text**: `Chatty Nymph`

#### åˆå¹¶é€»è¾‘å¤„ç† (5.1)

1. **å†…å®¹æ— å˜åŒ–**: `key` ç›¸åŒï¼Œ`text` å’Œ `EN` ç›¸åŒ
   - **å¤„ç†**: åˆ é™¤è¿™ä¸ªå‚æ•°ï¼ˆæ— éœ€å˜æ›´ï¼‰

2. **å†…å®¹æœ‰æ›´æ–°**: `key` ç›¸åŒï¼Œ`text` å’Œ `EN` ä¸åŒ
   - **å¤„ç†**: `text` æ›¿æ¢ `EN`ï¼Œå¹¶ä¿ç•™å†å²æ³¨é‡Šï¼ŒåŒæ­¥ EN æ³¨é‡Š

3. **æ–°å¢å†…å®¹**: `key` ä¸å­˜åœ¨
   - **å¤„ç†**: æ–°å¢ï¼Œå¸¦ EN æ³¨é‡Š

> **è¯´æ˜**: æœ¬æµç¨‹ä»…é€‚ç”¨äº DefInjected ç›®å½•çš„åˆå¹¶ä¸æ¨¡æ¿ç”Ÿæˆï¼ŒKeyed ç›®å½•ç›¸å…³æµç¨‹å‚è§ä¸‹æ–‡ã€‚

## ğŸ”‘ Keyed åˆå¹¶æµç¨‹è®¾è®¡

### 1. åˆå¹¶ä¸»ä»å…³ç³»
- **ä¸»å¯¼**: ä»¥è¾“å‡ºç›®å½• Keyed ä¸ºä¸»
- **å¢é‡**: è¾“å…¥ç›®å½•ï¼ˆæ–°æå–çš„æ•°æ®ï¼‰ä¸ºå¢é‡/æ›´æ–°
- **æ¯”å¯¹**: éå†è¾“å‡ºç›®å½• Keyed çš„ keyï¼Œå’Œè¾“å…¥ç›®å½•æ–°æå–çš„ key è¿›è¡Œæ¯”å¯¹ï¼ŒæŒ‰ä¸‹è¿°é€»è¾‘å¤„ç†

### 2. Keyed åˆå¹¶é€»è¾‘
- **å†…å®¹æ— å˜åŒ–**: `input_key == output_key && output_text == input_EN`
  - **å¤„ç†**: ä¸æ›´æ”¹
- **å†…å®¹æœ‰æ›´æ–°**: `input_key == output_key && output_text != input_EN`
  - **å¤„ç†**: `output_text` æ›¿æ¢ `input_text`ï¼Œ**ä¿ç•™å†å²æ³¨é‡Š**
- **æ–°å¢å†…å®¹**: `input_key` ä¸å­˜åœ¨
  - **å¤„ç†**: æ–°å¢

### 3. æ³¨é‡Šä¸å†å²è§„èŒƒ

#### å†å²æ³¨é‡Šæ ¼å¼
```xml
<!--HISTORY: åŸç¿»è¯‘å†…å®¹ï¼šæ—§å†…å®¹ï¼Œæ›¿æ¢äº2024-06-07-->
<SomeKey>æ–°å†…å®¹</SomeKey>
```

#### è‹±æ–‡æ³¨é‡Šæ ¼å¼ï¼ˆå¯é€‰ï¼‰
```xml
<!--EN: è‹±æ–‡åŸæ–‡-->
<SomeKey>ä¸­æ–‡ç¿»è¯‘</SomeKey>
```

#### æ³¨é‡Šè§„åˆ™
- å†å²æ³¨é‡Šå¯æ”¾åœ¨ key èŠ‚ç‚¹å‰
- å¦‚æœ‰è‹±æ–‡åŸæ–‡éœ€æ±‚ï¼Œå¯åŠ  EN æ³¨é‡Šï¼Œä¿æŒä¸ DefInjected ä¸€è‡´
- æ³¨é‡Šé¡ºåºï¼šå†å²æ³¨é‡Šåœ¨å‰ï¼ŒEN æ³¨é‡Šåœ¨å

### 4. Keyed åˆå¹¶æµç¨‹å›¾

```mermaid
graph TD
    A[Keyed: keyå·²å­˜åœ¨?] -->|æ˜¯| B[å†…å®¹ç›¸åŒ?]
    B -->|æ˜¯| C[ä¸å˜]
    B -->|å¦| D[æ›¿æ¢, åŠ HISTORYæ³¨é‡Š]
    A -->|å¦| E[æ–°å¢]
```

### 5. å®ç°å»ºè®®

- **è‡ªåŠ¨åŒ–åˆå¹¶**: å»ºè®®ä¸ DefInjected åˆå¹¶æµç¨‹ä¿æŒä¸€è‡´çš„ä¸»ä»åˆ¤å®šã€æ³¨é‡Šã€å†å²è§„èŒƒ
- **æ•°æ®ç»“æ„**: ä½¿ç”¨ä¸ DefInjected ç›¸åŒçš„äº”å…ƒç»„æ ¼å¼ `(key, text, tag, rel_path, en_text)`
- **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨ dict ç»“æ„åŠ é€Ÿ key åŒ¹é…
- **é”™è¯¯å¤„ç†**: å¢åŠ å¯¹ Keyed æ–‡ä»¶ç‰¹æœ‰ç»“æ„çš„å¼‚å¸¸å¤„ç†

## ğŸ’» æ™ºèƒ½åˆå¹¶æ ¸å¿ƒå®ç°

### ä¼ªä»£ç æ¡†æ¶

```python
def perform_smart_merge(output_dir, new_translations, smart_merger):
    """
    æ™ºèƒ½åˆå¹¶ä¸»æµç¨‹
    éå†è¾“å‡ºç›®å½•ä¸‹æ‰€æœ‰ DefInjected/Keyed æ–‡ä»¶ï¼Œæå–ç°æœ‰ç¿»è¯‘ï¼Œ
    ä¸ new_translations æŒ‰ key æ¯”å¯¹ï¼ŒæŒ‰ 5.1 é€»è¾‘åˆå¹¶ï¼Œ
    æ‰¹é‡è°ƒç”¨ smart_merger.merge_multiple_filesã€‚
    è¿”å›åˆå¹¶ç»“æœç»Ÿè®¡ã€‚
    """
    # 1. éå†è¾“å‡ºç›®å½• DefInjected/Keyed ä¸‹æ‰€æœ‰ xml æ–‡ä»¶
    xml_files = find_all_xml_files(output_dir)
    
    # 2. å¯¹æ¯ä¸ªæ–‡ä»¶ï¼Œè°ƒç”¨ extract_file_translations æå–å±äºè¯¥æ–‡ä»¶çš„ç¿»è¯‘
    file_mappings = {}
    for xml_file in xml_files:
        existing_translations = extract_file_translations(xml_file, existing_data)
        new_file_translations = extract_file_translations(xml_file, new_translations)
        merged_translations = merge_translations(existing_translations, new_file_translations)
        file_mappings[xml_file] = merged_translations
    
    # 3. ç»„è£… file_mappingsï¼Œæ‰¹é‡åˆå¹¶
    merge_results = smart_merger.merge_multiple_files(file_mappings)
    
    # 4. è¿”å›åˆå¹¶ç»Ÿè®¡ç»“æœ
    return generate_merge_statistics(merge_results)

def extract_file_translations(xml_file, translations):
    """
    æ–‡ä»¶çº§ç¿»è¯‘æå–
    æ ¹æ® xml_file çš„æ–‡ä»¶å/è·¯å¾„ï¼Œä» translations ä¸­ç­›é€‰å‡º
    å±äºè¯¥æ–‡ä»¶çš„ key-text å¯¹ï¼Œè¿”å› {key: text}
    """
    # 1. è·å– xml_file çš„æ–‡ä»¶å/ç›¸å¯¹è·¯å¾„
    file_identifier = get_file_identifier(xml_file)
    
    # 2. éå† translationsï¼Œç­›é€‰ file_info åŒ¹é…çš„ key-text
    file_translations = {}
    for translation in translations:
        if translation.file_info == file_identifier:
            file_translations[translation.key] = translation
    
    # 3. è¿”å›å­—å…¸
    return file_translations

def merge_translations(existing, new):
    """
    æŒ‰ç…§ 5.1 åˆå¹¶é€»è¾‘å¤„ç†ç¿»è¯‘æ•°æ®
    """
    merged = {}
    
    # å¤„ç†ç°æœ‰ç¿»è¯‘
    for key, translation in existing.items():
        if key in new:
            # æ¯”è¾ƒå†…å®¹å†³å®šæ˜¯å¦æ›´æ–°
            if translation.text != new[key].en_text:
                # éœ€è¦æ›´æ–°ï¼Œä¿ç•™å†å²
                updated_translation = create_updated_translation(
                    translation, new[key], add_history=True
                )
                merged[key] = updated_translation
            else:
                # å†…å®¹ç›¸åŒï¼Œä¿æŒåŸçŠ¶
                merged[key] = translation
        else:
            # æ–°æ•°æ®ä¸­ä¸å­˜åœ¨ï¼Œä¿æŒåŸçŠ¶
            merged[key] = translation
    
    # å¤„ç†æ–°å¢ç¿»è¯‘
    for key, translation in new.items():
        if key not in existing:
            # æ–°å¢ç¿»è¯‘ï¼Œæ·»åŠ  EN æ³¨é‡Š
            new_translation = create_new_translation(translation, add_en_comment=True)
            merged[key] = new_translation
    
    return merged
```

---